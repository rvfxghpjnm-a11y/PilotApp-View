<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>PilotApp</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: #0b0b0b;
  color: #fff;
}
header {
  padding: 14px 18px;
  font-size: 20px;
  font-weight: 600;
  background: #121212;
  border-bottom: 1px solid #222;
}
.container { padding: 16px; }
button {
  background: #1e1e1e;
  color: #ccc;
  border: 1px solid #333;
  border-radius: 8px;
  padding: 8px 12px;
  margin-right: 6px;
  cursor: pointer;
}
button.active {
  background: #0a84ff;
  color: #fff;
  border-color: #0a84ff;
}
.card {
  margin-top: 14px;
  background: #151515;
  border-radius: 14px;
  padding: 14px;
}
pre {
  white-space: pre-wrap;
  font-family: ui-monospace, Menlo, monospace;
}
.hidden { display: none; }
canvas { width:100% !important; height:320px !important; }
.small { opacity:.6; font-size:13px }
</style>
</head>

<body>
<header>PilotApp</header>

<div class="container">

<div id="persons"></div>

<div style="margin-top:10px">
  <button id="btnShort">Short</button>
  <button id="btnLong">Long</button>
  <button id="btnGraph">Graph</button>
  <button onclick="manualRefresh()">↻</button>
  <span class="small" id="refreshTime"></span>
</div>

<div id="textCard" class="card">
  <pre id="content">Lade…</pre>
</div>

<div id="graphCard" class="card hidden">
  <div style="margin-bottom:10px">
    <button onclick="setWindow(3)">3h</button>
    <button onclick="setWindow(6)">6h</button>
    <button onclick="setWindow(12)">12h</button>
    <button onclick="setWindow(24)">24h</button>
  </div>
  <canvas id="chart"></canvas>
</div>

</div>

<script>
/* ===============================
   STATE (persistiert)
================================ */
const STATE_KEY = "pilotapp_state";
let state = JSON.parse(localStorage.getItem(STATE_KEY)) || {
  person: "konietzka_stefan",
  mode: "short",
  window: 24
};

const PERSONS = ["konietzka_stefan","crotogino_philipp"];
let chart;

/* ===============================
   INIT
================================ */
renderPersons();
applyState();
reload();

/* ===============================
   UI
================================ */
function save() {
  localStorage.setItem(STATE_KEY, JSON.stringify(state));
}

function renderPersons() {
  const box = document.getElementById("persons");
  box.innerHTML = "";
  PERSONS.forEach(p => {
    const b = document.createElement("button");
    b.textContent = p.replace("_"," ");
    b.classList.toggle("active", p===state.person);
    b.onclick = () => { state.person=p; save(); renderPersons(); reload(); };
    box.appendChild(b);
  });
}

function applyState() {
  setMode(state.mode,false);
}

function setMode(m,saveState=true) {
  state.mode=m;
  if(saveState) save();
  ["short","long","graph"].forEach(x=>{
    document.getElementById("btn"+cap(x)).classList.toggle("active",m===x);
  });
  document.getElementById("textCard").classList.toggle("hidden",m==="graph");
  document.getElementById("graphCard").classList.toggle("hidden",m!=="graph");
}

function setWindow(h) {
  state.window=h;
  save();
  loadGraph();
}

function manualRefresh() {
  reload(true);
}

/* ===============================
   DATA
================================ */
async function reload(force=false) {
  updateTime();
  if(state.mode==="graph") {
    await loadGraph(force);
  } else {
    await loadText(force);
  }
}

async function loadText() {
  const r = await fetch(`data/${state.person}_${state.mode}.json?${Date.now()}`);
  if(!r.ok) return;
  const j = await r.json();
  document.getElementById("content").textContent = j.short || j.long || "–";
}

async function loadGraph() {
  const r = await fetch(`data/workstart_history_${state.person}.json?${Date.now()}`);
  if(!r.ok) return;
  const j = await r.json();
  const cutoff = Date.now() - state.window*3600*1000;

  const rows = j.entries.map(e=>({
    t:new Date(e.ts),
    m:hm(e.from_meldung),
    a:hm(e.from_meldung_alt),
    d2:hm(e.calc_div2),
    d3:hm(e.calc_div3)
  })).filter(r=>r.t>=cutoff);

  requestAnimationFrame(()=>draw(rows));
}

/* ===============================
   CHART
================================ */
function draw(rows) {
  if(chart) chart.destroy();
  chart = new Chart(document.getElementById("chart"),{
    type:"line",
    data:{datasets:[
      ds("Meldung",rows,"m","#0a84ff"),
      ds("Alt",rows,"a","#64d2ff"),
      ds("Div2",rows,"d2","#30d158"),
      ds("Div3",rows,"d3","#ffd60a")
    ]},
    options:{
      parsing:false,
      scales:{
        x:{type:"time",time:{unit:"hour"}},
        y:{reverse:true}
      }
    }
  });
}

function ds(label,rows,k,c){
  return{
    label,
    data:rows.map(r=>r[k]?{x:r.t,y:r[k]}:null),
    spanGaps:true,
    borderColor:c,
    tension:.25
  }
}

/* ===============================
   HELPERS
================================ */
function hm(v){
  if(!v) return null;
  const m=v.match(/(\d{2}):(\d{2})/);
  if(!m) return null;
  const d=new Date();
  d.setHours(+m[1],+m[2],0,0);
  return d;
}
function cap(s){return s[0].toUpperCase()+s.slice(1);}
function updateTime(){
  document.getElementById("refreshTime").textContent =
    "aktualisiert: "+new Date().toLocaleTimeString();
}
</script>
</body>
</html>
