<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PilotApp</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">

<style>
:root {
  --bg: #000;
  --card: #1c1c1e;
  --accent: #0a84ff;
  --border: #2c2c2e;
  --text: #fff;
  --muted: #a1a1a6;
}

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg);
  color: var(--text);
}

header {
  background: var(--card);
  padding: 12px;
  border-bottom: 1px solid var(--border);
}

.titlebar {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.titlebar h1 {
  font-size: 18px;
  margin: 0;
}

.titlebar button {
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 8px 12px;
  font-size: 14px;
}

.persons {
  display: flex;
  overflow-x: auto;
  gap: 8px;
  padding: 10px 0 4px;
}

.person {
  white-space: nowrap;
  padding: 8px 14px;
  border-radius: 18px;
  background: #2c2c2e;
  font-size: 14px;
  cursor: pointer;
}

.person.active {
  background: var(--accent);
}

main {
  padding: 12px;
}

.controls {
  margin-bottom: 10px;
}

.controls button {
  padding: 8px 14px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: #2c2c2e;
  color: var(--text);
  margin-right: 6px;
  font-size: 14px;
}

.controls button.active {
  background: var(--accent);
}

.status {
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 6px;
}

pre {
  background: var(--card);
  padding: 14px;
  border-radius: 12px;
  white-space: pre-wrap;
  font-size: 14px;
}

canvas {
  width: 100%;
  height: 260px;
  background: var(--card);
  border-radius: 12px;
}
</style>
</head>

<body>

<header>
  <div class="titlebar">
    <h1>PilotApp</h1>
    <button onclick="manualRefresh()">â†»</button>
  </div>
  <div class="persons" id="persons"></div>
</header>

<main>
  <div class="controls">
    <button id="btnShort" onclick="setMode('short')">Short</button>
    <button id="btnLong" onclick="setMode('long')">Long</button>
    <button id="btnGraph" onclick="setMode('graph')">ðŸ“ˆ Graph</button>
  </div>

  <div class="status" id="status">â€“</div>

  <pre id="content">Lade Datenâ€¦</pre>
  <canvas id="graph" style="display:none"></canvas>
</main>

<script>
const DATA_DIR = "data/";
const GITHUB_USER = "rvfxghpjnm-a11y";
const GITHUB_REPO = "PilotApp-View";
const GITHUB_BRANCH = "main";

let persons = [];
let currentKey = localStorage.getItem("pilotapp_person");
let currentMode = localStorage.getItem("pilotapp_mode") || "short";

async function loadPersons() {
  const api =
    `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/data?ref=${GITHUB_BRANCH}`;
  const res = await fetch(api);
  const files = await res.json();

  persons = files
    .filter(f => f.name.endsWith("_short.json"))
    .map(f => f.name.replace("_short.json", ""))
    .sort();

  if (!currentKey || !persons.includes(currentKey)) {
    currentKey = persons[0];
    localStorage.setItem("pilotapp_person", currentKey);
  }

  renderPersons();
  setMode(currentMode, false);
}

function renderPersons() {
  const box = document.getElementById("persons");
  box.innerHTML = "";
  persons.forEach(k => {
    const d = document.createElement("div");
    d.className = "person" + (k === currentKey ? " active" : "");
    d.textContent = k.replace("_", " ");
    d.onclick = () => {
      currentKey = k;
      localStorage.setItem("pilotapp_person", k);
      renderPersons();
      load();
    };
    box.appendChild(d);
  });
}

function setMode(m, loadNow = true) {
  currentMode = m;
  localStorage.setItem("pilotapp_mode", m);

  ["short","long","graph"].forEach(x =>
    document.getElementById("btn"+x.charAt(0).toUpperCase()+x.slice(1))
      .classList.toggle("active", m===x)
  );

  document.getElementById("content").style.display =
    m === "graph" ? "none" : "block";
  document.getElementById("graph").style.display =
    m === "graph" ? "block" : "none";

  if (loadNow) load();
}

async function load() {
  if (!currentKey) return;

  if (currentMode === "graph") {
    drawGraph();
    return;
  }

  const url = `${DATA_DIR}${currentKey}_${currentMode}.json?ts=${Date.now()}`;
  const res = await fetch(url);
  const data = await res.json();

  document.getElementById("content").textContent =
    data.short || data.long || "â€“";

  document.getElementById("status").textContent =
    "Aktualisiert: " + new Date().toLocaleTimeString();
}

async function drawGraph() {
  const url = `${DATA_DIR}workstart_history_${currentKey}.jsonl?ts=${Date.now()}`;
  const res = await fetch(url);
  const text = await res.text();

  const rows = text.trim().split("\n").map(JSON.parse);
  const ctx = document.getElementById("graph").getContext("2d");
  ctx.clearRect(0,0,1000,300);

  if (!rows.length) return;

  const xs = rows.map((_,i)=>i);
  const ys = rows.map(r=>r.minutes);

  const minY = Math.min(...ys);
  const maxY = Math.max(...ys);

  ctx.strokeStyle = "#0a84ff";
  ctx.beginPath();
  rows.forEach((r,i)=>{
    const x = i*(ctx.canvas.width/(rows.length-1));
    const y = ctx.canvas.height -
      ((r.minutes-minY)/(maxY-minY||1))*ctx.canvas.height;
    if (i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  });
  ctx.stroke();

  document.getElementById("status").textContent =
    "Workstart-Historie";
}

function manualRefresh(){ load(); }

loadPersons();
setInterval(load,60000);
</script>

</body>
</html>
