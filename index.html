<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PilotApp</title>

<!-- PWA -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

<style>
:root {
  --bg: #000;
  --card: #1c1c1e;
  --accent: #0a84ff;
  --border: #2c2c2e;
  --text: #fff;
  --muted: #a1a1a6;
}

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg);
  color: var(--text);
}

header {
  background: var(--card);
  padding: 12px;
  border-bottom: 1px solid var(--border);
}

.titlebar {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.titlebar h1 {
  font-size: 18px;
  margin: 0;
}

.titlebar button {
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 8px 12px;
}

.persons {
  display: flex;
  overflow-x: auto;
  gap: 8px;
  padding: 10px 0 4px;
}

.person {
  white-space: nowrap;
  padding: 8px 14px;
  border-radius: 18px;
  background: #2c2c2e;
  font-size: 14px;
  cursor: pointer;
}

.person.active {
  background: var(--accent);
}

main {
  padding: 12px;
}

.controls {
  margin-bottom: 10px;
}

.controls button {
  padding: 8px 14px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: #2c2c2e;
  color: var(--text);
  margin-right: 6px;
}

.controls button.active {
  background: var(--accent);
}

.status {
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 6px;
}

pre {
  background: var(--card);
  padding: 14px;
  border-radius: 12px;
  white-space: pre-wrap;
  font-size: 14px;
}

section {
  margin-top: 20px;
  background: var(--card);
  padding: 12px;
  border-radius: 12px;
}

canvas {
  width: 100% !important;
}
</style>
</head>

<body>

<header>
  <div class="titlebar">
    <h1>PilotApp</h1>
    <button onclick="load()">↻</button>
  </div>
  <div class="persons" id="persons"></div>
</header>

<main>

  <div class="controls">
    <button id="btnShort" onclick="setMode('short')">Short</button>
    <button id="btnLong" onclick="setMode('long')">Long</button>
  </div>

  <div class="status" id="status">–</div>
  <pre id="content">Lade Daten…</pre>

  <!-- WORKSTART -->
  <section>
    <h2>Workstart-Verlauf</h2>
    <canvas id="workstartChart" height="140"></canvas>
  </section>

</main>

<script>
const DATA_DIR = "data/";
let persons = [];
let currentKey = localStorage.getItem("pilotapp_person");
let currentMode = localStorage.getItem("pilotapp_mode") || "short";
let chart = null;

async function loadPersons() {
  const res = await fetch("data/");
  const html = await res.text();

  persons = [...html.matchAll(/href="([^"]+)_short\.json"/g)]
    .map(m => m[1])
    .sort();

  if (!currentKey || !persons.includes(currentKey)) {
    currentKey = persons[0];
  }

  renderPersons();
  setMode(currentMode, false);
}

function renderPersons() {
  const box = document.getElementById("persons");
  box.innerHTML = "";

  persons.forEach(k => {
    const d = document.createElement("div");
    d.className = "person" + (k === currentKey ? " active" : "");
    d.textContent = k.replace("_", " ");
    d.onclick = () => {
      currentKey = k;
      localStorage.setItem("pilotapp_person", k);
      renderPersons();
      load();
      loadWorkstart();
    };
    box.appendChild(d);
  });
}

function setMode(m, reload = true) {
  currentMode = m;
  localStorage.setItem("pilotapp_mode", m);
  btnShort.classList.toggle("active", m === "short");
  btnLong.classList.toggle("active", m === "long");
  if (reload) load();
}

async function load() {
  const res = await fetch(`${DATA_DIR}${currentKey}_${currentMode}.json?ts=${Date.now()}`);
  const data = await res.json();
  content.textContent = data[currentMode] || "–";
  status.textContent = "Aktualisiert: " + new Date().toLocaleTimeString();
}

async function loadWorkstart() {
  const res = await fetch(`${DATA_DIR}workstart_history_${currentKey}.json`);
  const data = await res.json();

  const toDate = s => s ? new Date(s.replace(" ", "T")) : null;

  const labels = data.entries.map(e => toDate(e.ts_calc));
  const line = k => data.entries.map(e => toDate(e[k]));

  if (chart) chart.destroy();

  chart = new Chart(workstartChart, {
    type: "line",
    data: {
      labels,
      datasets: [
        { label: "DIV 2", data: line("calc_div2"), borderColor: "#4caf50" },
        { label: "DIV 3", data: line("calc_div3"), borderColor: "#2196f3" },
        { label: "Meldung", data: line("from_meldung"), borderColor: "#ff9800", borderDash: [5,5] },
        { label: "Alt. Meldung", data: line("from_meldung_alt"), borderColor: "#f44336", borderDash: [2,4] }
      ]
    },
    options: {
      interaction: { mode: "index", intersect: false },
      scales: {
        x: { type: "time" },
        y: {
          ticks: {
            callback: v => new Date(v).toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"})
          }
        }
      }
    }
  });
}

loadPersons().then(() => {
  load();
  loadWorkstart();
});
</script>

</body>
</html>
