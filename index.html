<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>PilotApp</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: #0b0b0b;
  color: #fff;
}

header {
  padding: 14px 18px;
  font-size: 20px;
  font-weight: 600;
  background: #121212;
  border-bottom: 1px solid #222;
}

.container {
  padding: 16px;
}

button {
  background: #1e1e1e;
  color: #ccc;
  border: 1px solid #333;
  border-radius: 8px;
  padding: 8px 12px;
  margin-right: 6px;
  cursor: pointer;
}

button.active {
  background: #0a84ff;
  color: #fff;
  border-color: #0a84ff;
}

.card {
  margin-top: 14px;
  background: #151515;
  border-radius: 14px;
  padding: 14px;
}

pre {
  white-space: pre-wrap;
  font-family: ui-monospace, Menlo, monospace;
  font-size: 14px;
}

canvas {
  width: 100% !important;
  height: 320px !important;
}

.hidden {
  display: none;
}
</style>
</head>

<body>

<header>PilotApp</header>

<div class="container">

  <!-- PERSONEN -->
  <div id="persons"></div>

  <!-- MODUS -->
  <div style="margin-top:10px">
    <button id="btnShort" class="active" onclick="setMode('short')">Short</button>
    <button id="btnLong" onclick="setMode('long')">Long</button>
    <button id="btnGraph" onclick="setMode('graph')">Graph</button>
  </div>

  <!-- TEXT -->
  <div id="textCard" class="card">
    <pre id="content">Lade Daten…</pre>
  </div>

  <!-- GRAPH -->
  <div id="graphCard" class="card hidden">
    <div style="margin-bottom:10px">
      <button onclick="setWindow(3)">3h</button>
      <button onclick="setWindow(6)">6h</button>
      <button onclick="setWindow(12)">12h</button>
      <button class="active" onclick="setWindow(24)">24h</button>
    </div>
    <canvas id="chart"></canvas>
  </div>

</div>

<script>
/* ==============================
   KONFIG
============================== */

const PERSONS = [
  "konietzka_stefan",
  "crotogino_philipp"
];

let currentKey = PERSONS[0];
let mode = "short";
let windowHours = 24;
let chart;

/* ==============================
   INIT
============================== */

renderPersons();
loadText();

/* ==============================
   UI
============================== */

function renderPersons() {
  const box = document.getElementById("persons");
  box.innerHTML = "";

  PERSONS.forEach(p => {
    const b = document.createElement("button");
    b.textContent = p.replace("_", " ");
    if (p === currentKey) b.classList.add("active");
    b.onclick = () => {
      currentKey = p;
      renderPersons();
      reload();
    };
    box.appendChild(b);
  });
}

function setMode(m) {
  mode = m;

  document.getElementById("btnShort").classList.toggle("active", m === "short");
  document.getElementById("btnLong").classList.toggle("active", m === "long");
  document.getElementById("btnGraph").classList.toggle("active", m === "graph");

  document.getElementById("textCard").classList.toggle("hidden", m === "graph");
  document.getElementById("graphCard").classList.toggle("hidden", m !== "graph");

  reload();
}

function reload() {
  if (mode === "graph") {
    loadWorkstart();
  } else {
    loadText();
  }
}

function setWindow(h) {
  windowHours = h;
  document.querySelectorAll("#graphCard button").forEach(b => b.classList.remove("active"));
  event.target.classList.add("active");
  loadWorkstart();
}

/* ==============================
   SHORT / LONG
============================== */

async function loadText() {
  const url = `data/${currentKey}_${mode}.json`;
  const res = await fetch(url);
  if (!res.ok) return;

  const data = await res.json();
  document.getElementById("content").textContent =
    data.short || data.long || "–";
}

/* ==============================
   WORKSTART GRAPH
============================== */

async function loadWorkstart() {
  const res = await fetch(`data/workstart_history_${currentKey}.json`);
  if (!res.ok) return;

  const data = await res.json();
  const entries = data.entries || [];

  const now = Date.now();
  const cutoff = now - windowHours * 3600 * 1000;

  const rows = entries.map(e => ({
    ts: new Date(e.ts),
    m: parseHM(e.from_meldung),
    a: parseHM(e.from_meldung_alt),
    d2: parseHM(e.calc_div2),
    d3: parseHM(e.calc_div3),
  })).filter(r => r.ts && r.ts.getTime() >= cutoff);

  drawChart(rows);
}

function drawChart(rows) {
  if (chart) chart.destroy();

  chart = new Chart(document.getElementById("chart"), {
    type: "line",
    data: {
      datasets: [
        mk("Meldung", rows, "m", "#0a84ff"),
        mk("Alt", rows, "a", "#64d2ff"),
        mk("Div2", rows, "d2", "#30d158"),
        mk("Div3", rows, "d3", "#ffd60a"),
      ]
    },
    options: {
      parsing: false,
      scales: {
        x: { type: "time", time: { unit: "hour" } },
        y: { reverse: true }
      }
    }
  });
}

function mk(label, rows, key, color) {
  return {
    label,
    data: rows.map(r => r[key] ? { x: r.ts, y: r[key] } : null),
    spanGaps: true,
    borderColor: color,
    tension: 0.25
  };
}

function parseHM(v) {
  if (!v) return null;
  const m = v.match(/(\d{2}):(\d{2})/);
  if (!m) return null;
  const d = new Date();
  d.setHours(+m[1], +m[2], 0, 0);
  return d;
}
</script>

</body>
</html>
