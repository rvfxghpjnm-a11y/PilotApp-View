<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Workstart Graph</title>

  <style>
    .graph-container {
      padding: 1rem;
    }

    .graph-toolbar {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .graph-toolbar button {
      padding: 0.4rem 0.8rem;
      border: 1px solid #555;
      background: #222;
      color: #fff;
      cursor: pointer;
    }

    .graph-toolbar button.active {
      background: #0a84ff;
      border-color: #0a84ff;
    }

    canvas {
      width: 100%;
      max-height: 400px;
      background: #111;
    }

    .hint {
      opacity: 0.7;
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>

<div class="graph-container">

  <div class="graph-toolbar">
    <strong>Zeitfenster:</strong>
    <button data-window="3">3h</button>
    <button data-window="6">6h</button>
    <button data-window="12">12h</button>
    <button data-window="24">24h</button>
  </div>

  <canvas id="workstartChart"></canvas>

  <div class="hint">
    Linien: Meldung · Alt · Ø/2 · Ø/3
  </div>

</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ============================================================
   STATE
   ============================================================ */

const state = window.PilotAppState;
const person = state.person;
const timeWindow = state.window || 12;

/* ============================================================
   BUTTON STATE
   ============================================================ */

document.querySelectorAll('[data-window]').forEach(btn => {
  if (Number(btn.dataset.window) === timeWindow) {
    btn.classList.add('active');
  }

  btn.addEventListener('click', () => {
    state.window = Number(btn.dataset.window);
    state.save();
    location.reload();
  });
});

/* ============================================================
   DATA LOADING
   ============================================================ */

const dataUrl = `data/workstart_history_${person.nachname}_${person.vorname}.json`;

fetch(dataUrl)
  .then(r => r.json())
  .then(renderGraph)
  .catch(err => {
    console.error("Graph Datenfehler:", err);
  });

/* ============================================================
   GRAPH LOGIC
   ============================================================ */

function renderGraph(data) {
  const now = new Date();
  const cutoff = new Date(now.getTime() - timeWindow * 3600 * 1000);

  const entries = data.entries.filter(e => {
    return new Date(e.ts_calc || e.ts) >= cutoff;
  });

  const labels = entries.map(e =>
    new Date(e.ts_calc || e.ts).toLocaleTimeString("de-DE", {
      hour: "2-digit",
      minute: "2-digit"
    })
  );

  const line = key =>
    entries.map(e => timeToFloat(e[key]));

  const datasets = [
    makeLine("from_meldung", "Meldung", "#00c853"),
    makeLine("from_meldung_alt", "Alt", "#ffab00"),
    makeLine("calc_div2", "Ø / 2", "#2979ff"),
    makeLine("calc_div3", "Ø / 3", "#d500f9"),
  ];

  const ctx = document.getElementById("workstartChart").getContext("2d");

  new Chart(ctx, {
    type: "line",
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          ticks: {
            callback: v => floatToTime(v)
          }
        }
      }
    }
  });
}

/* ============================================================
   HELPERS
   ============================================================ */

function makeLine(key, label, color) {
  return {
    label,
    data: line(key),
    borderColor: color,
    backgroundColor: color,
    tension: 0.2,
    spanGaps: true,
  };
}

function timeToFloat(t) {
  if (!t) return null;
  const [h, m] = t.slice(-5).split(":").map(Number);
  return h + m / 60;
}

function floatToTime(f) {
  if (f == null) return "";
  const h = Math.floor(f);
  const m = Math.round((f - h) * 60);
  return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
}
</script>

</body>
</html>